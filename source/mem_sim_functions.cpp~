#include "libs.h"
#include "mem_sim_functions.hpp"
#include "mem_sim_classes.hpp"
using namespace std;


string readOrWrite (map<long, string>& cacheData, vector<list<Block>>& cacheVect, const Parameters& P, unsigned address, bool write) {
	int accessTime = 0;

	accessTime += P.hitTime;
	
	unsigned currentbAddress = address/(P.bytePerWord*P.wordPerBlock);
	unsigned setIndex = currentbAddress % P.setPerCache;
	bool hit = 0;
	list<Block>::iterator it;
	Block blockToWrite(currentbAddress,write);
	for(it = cacheVect[setIndex].begin(); it != cacheVect[setIndex].end(); ++it) {
		if (it->bAddress == currentbAddress) {
			hit = 1;
			break;
		}
	}
	if (hit == 1) {
		if (it->dirtyBit == 0) {
			it->dirtyBit = write;
		}
		cacheVect[setIndex].splice(cacheVect[setIndex].begin(), cacheVect[setIndex], it);
	} else {
		if (cacheVect[setIndex].size() == P.blockPerSet) {
			--it;
			if(it->dirtyBit == 1) {
				accessTime += P.writeTime;				
			}
			cacheVect[setIndex].erase(it);
		}
		if (!(write == true && P.wordPerBlock == 1)) {
			accessTime += P.readTime;
		}
		
		cacheVect[setIndex].push_front(blockToWrite);
	}
	VOUT(accessTime);


	string outputString;
	if (write) {
		outputString = makeWriteOutput(setIndex,hit,accessTime);
	} else {
		outputString = makeReadOutput(cacheData,address,P,setIndex,hit,accessTime);
	}
	return outputString;

}	

string makeReadOutput(map<long, string>& cacheData, unsigned address, const Parameters& P, int setIndex, bool hit, int accessTime) {
	string hitString;
	stringstream ss;
	string data;
	if(hit == 1) {
		hitString = "hit";
	} else {
		hitString = "miss";
	}
	if (cacheData.count(address) == 1) {
		data = cacheData.find(address)->second;
	} else {
		data = "0";
	}
	ss << "read-ack " << setIndex << " " << hitString << " " << accessTime << " " << uppercase << setfill('0') << setw(2*P.bytePerWord) << data << endl;
	return ss.str();
}


string makeWriteOutput(int setIndex, bool hit, int accessTime) {
	string hitString;
	stringstream ss;
	if(hit == 1) {
		hitString = "hit";
	} else {
		hitString = "miss";
	}
	ss << "write-ack " << setIndex << " " << hitString << " " << accessTime << endl;
	return ss.str();
}
